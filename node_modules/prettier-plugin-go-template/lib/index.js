"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.printers = exports.languages = exports.parsers = void 0;
const prettier_1 = require("prettier");
const parser_html_1 = require("prettier/parser-html");
const blockHashes = new Array();
const htmlParser = parser_html_1.parsers.html;
let _id = 0;
const getId = () => {
    _id = _id + (1 % Number.MAX_SAFE_INTEGER);
    return _id.toString();
};
const buildReplacement = (input) => {
    const id = getId();
    if (input.match(/{{[-<]? (?:if|range|block|with|define)/)) {
        blockHashes.push(id);
        return `<BPGT${id}EPGT>`;
    }
    if (input.match(/{{[-<]? end/)) {
        return `</BPGT${blockHashes.pop()}EPGT>`;
    }
    return `BPGT${id}EPGT`;
};
const replacements = new Map();
exports.parsers = {
    "go-template": Object.assign(Object.assign({}, htmlParser), { astFormat: "go-template", preprocess: (text) => {
            const regexp = /(?:{{.*?}})|(?:<script(?:\n|.)*?>)((?:\n|.)*?)(?:<\/script>)/gm;
            let replacedText = text.trim();
            let match;
            while ((match = regexp.exec(text)) != null) {
                const result = match[0];
                if (!result.includes("{{")) {
                    continue;
                }
                const cleanedResult = result
                    .replace(/{{(?![-<]|(?:\/\*))[ \t]*/g, "{{ ")
                    .replace(/[ \t]*(?<![->]|(?:\*\/))}}/g, " }}")
                    .replace(/{{-[ \t]*/g, "{{- ")
                    .replace(/[ \t]*-}}/g, " -}}")
                    .replace(/{{<[ \t]*/g, "{{< ")
                    .replace(/[ \t]*>}}/g, " >}}")
                    .replace(/ *\n/g, "\n")
                    .trim();
                const replacement = buildReplacement(cleanedResult);
                replacedText = replacedText.replace(result, replacement);
                const forceLinebreak = !!replacedText.match(new RegExp(`^[ \t]*${replacement}[ \t]*$`, "gm"));
                if (forceLinebreak && !replacement.includes("<")) {
                    const linebreakReplacement = `<!--BPGT${replacement}EPGT-->`;
                    replacedText = replacedText.replace(replacement, linebreakReplacement);
                    replacements.set(linebreakReplacement, cleanedResult);
                }
                else {
                    replacements.set(replacement, cleanedResult);
                }
            }
            if (blockHashes.length > 0) {
                throw Error("Missing ending block.");
            }
            return replacedText;
        } }),
};
exports.languages = [
    {
        name: "GoTemplate",
        parsers: ["go-template"],
        extensions: [
            ".go.html",
            ".gohtml",
            ".gotmpl",
            ".go.tmpl",
            ".tmpl",
            ".tpl",
            ".html.tmpl",
            ".html.tpl",
        ],
        vscodeLanguageIds: ["gotemplate", "gohtml", "GoTemplate", "GoHTML"],
    },
];
function replaceSingles(input, replacedHashes = new Array()) {
    const regexp = /(?:<!--BPGT)?BPGT.*?EPGT(?:EPGT-->)?/g;
    let result = input;
    let match;
    while ((match = regexp.exec(input)) != null) {
        const hash = match[0];
        const replacement = replacements.get(hash);
        if (replacement) {
            result = result.replace(hash, replacement);
            replacedHashes.push(hash);
        }
    }
    return result;
}
let lastMissedBracket = false;
function replaceBlocks(input, replacedHashes = new Array()) {
    var _a, _b, _c, _d;
    let result = input;
    const fullOpeningTags = (_a = input.match(/<BPGT.*?EPGT>/g)) !== null && _a !== void 0 ? _a : [];
    const openOpeningTag = ((_b = input.match(/<BPGT.*?EPGT(?!>)/g)) !== null && _b !== void 0 ? _b : [])[0];
    const fullClosingTags = (_c = input.match(/<\/BPGT.*?EPGT>/g)) !== null && _c !== void 0 ? _c : [];
    const openClosingTag = ((_d = input.match(/<\/BPGT.*?EPGT(?!>)/g)) !== null && _d !== void 0 ? _d : [])[0];
    if (lastMissedBracket && input.match(/[\t ]*>/)) {
        lastMissedBracket = false;
        result = result.replace(/[\t ]*>/, "");
    }
    fullOpeningTags.forEach((openingTag) => {
        replacedHashes.push(openingTag);
        result = result.replace(openingTag, replacements.get(openingTag));
    });
    if (openOpeningTag) {
        const fixedOpeningTag = openOpeningTag + ">";
        lastMissedBracket = true;
        replacedHashes.push(fixedOpeningTag);
        result = result.replace(openOpeningTag, replacements.get(fixedOpeningTag));
    }
    fullClosingTags.forEach((fullClosingTag) => {
        replacedHashes.push(fullClosingTag);
        result = result.replace(fullClosingTag, replacements.get(fullClosingTag));
    });
    if (openClosingTag) {
        const fixedClosingTag = openClosingTag + ">";
        lastMissedBracket = true;
        replacedHashes.push(fixedClosingTag);
        result = result.replace(openClosingTag, replacements.get(fixedClosingTag));
    }
    return result;
}
exports.printers = {
    "go-template": {
        embed: (_, __, textToDoc, options) => {
            const htmlDoc = textToDoc(options.originalText, {
                parser: "html",
            });
            const replacedHashes = [];
            const mappedDoc = prettier_1.doc.utils.mapDoc(htmlDoc, (docLeaf) => {
                if (typeof docLeaf !== "string") {
                    return docLeaf;
                }
                let result = docLeaf;
                result = replaceSingles(result, replacedHashes);
                result = replaceBlocks(result, replacedHashes);
                return result;
            });
            replacedHashes.forEach((hash) => replacements.delete(hash));
            return mappedDoc;
        },
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQWlFO0FBQ2pFLHNEQUE4RDtBQUU5RCxNQUFNLFdBQVcsR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO0FBQ3hDLE1BQU0sVUFBVSxHQUFHLHFCQUFXLENBQUMsSUFBSSxDQUFDO0FBRXBDLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNaLE1BQU0sS0FBSyxHQUFHLEdBQUcsRUFBRTtJQUNqQixHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ3hCLENBQUMsQ0FBQztBQUVGLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRTtJQUN6QyxNQUFNLEVBQUUsR0FBRyxLQUFLLEVBQUUsQ0FBQztJQUVuQixJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsd0NBQXdDLENBQUMsRUFBRTtRQUN6RCxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JCLE9BQU8sUUFBUSxFQUFFLE9BQU8sQ0FBQztLQUMxQjtJQUVELElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBRTtRQUM5QixPQUFPLFNBQVMsV0FBVyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUM7S0FDMUM7SUFFRCxPQUFPLE9BQU8sRUFBRSxNQUFNLENBQUM7QUFDekIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxZQUFZLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7QUFFbEMsUUFBQSxPQUFPLEdBQUc7SUFDckIsYUFBYSxFQUFFLGdDQUNWLFVBQVUsS0FDYixTQUFTLEVBQUUsYUFBYSxFQUN4QixVQUFVLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUVuQixNQUFNLE1BQU0s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QUUsTUFBTTthQUNmLENBQUMsQ0FBQztZQUVILE1BQU0sY0FBYyxHQUFhLEVBQUUsQ0FBQztZQUVwQyxNQUFNLFNBQVMsR0FBRyxjQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDdEQsSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUU7b0JBQy9CLE9BQU8sT0FBTyxDQUFDO2lCQUNoQjtnQkFFRCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUM7Z0JBRXJCLE1BQU0sR0FBRyxjQUFjLENBQUMsTUFBTSxFQUFFLGNBQWMsQ0FBQyxDQUFDO2dCQUVoRCxNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFFL0MsT0FBTyxNQUFNLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7WUFFSCxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFFNUQsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQztLQUNGO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRvYywgUGFyc2VyLCBQcmludGVyLCBTdXBwb3J0TGFuZ3VhZ2UgfSBmcm9tIFwicHJldHRpZXJcIjtcbmltcG9ydCB7IHBhcnNlcnMgYXMgaHRtbFBhcnNlcnMgfSBmcm9tIFwicHJldHRpZXIvcGFyc2VyLWh0bWxcIjtcblxuY29uc3QgYmxvY2tIYXNoZXMgPSBuZXcgQXJyYXk8c3RyaW5nPigpO1xuY29uc3QgaHRtbFBhcnNlciA9IGh0bWxQYXJzZXJzLmh0bWw7XG5cbmxldCBfaWQgPSAwO1xuY29uc3QgZ2V0SWQgPSAoKSA9PiB7XG4gIF9pZCA9IF9pZCArICgxICUgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpO1xuICByZXR1cm4gX2lkLnRvU3RyaW5nKCk7XG59O1xuXG5jb25zdCBidWlsZFJlcGxhY2VtZW50ID0gKGlucHV0OiBzdHJpbmcpID0+IHtcbiAgY29uc3QgaWQgPSBnZXRJZCgpO1xuXG4gIGlmIChpbnB1dC5tYXRjaCgve3tbLTxdPyAoPzppZnxyYW5nZXxibG9ja3x3aXRofGRlZmluZSkvKSkge1xuICAgIGJsb2NrSGFzaGVzLnB1c2goaWQpO1xuICAgIHJldHVybiBgPEJQR1Qke2lkfUVQR1Q+YDtcbiAgfVxuXG4gIGlmIChpbnB1dC5tYXRjaCgve3tbLTxdPyBlbmQvKSkge1xuICAgIHJldHVybiBgPC9CUEdUJHtibG9ja0hhc2hlcy5wb3AoKX1FUEdUPmA7XG4gIH1cblxuICByZXR1cm4gYEJQR1Qke2lkfUVQR1RgO1xufTtcblxuY29uc3QgcmVwbGFjZW1lbnRzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcblxuZXhwb3J0IGNvbnN0IHBhcnNlcnMgPSB7XG4gIFwiZ28tdGVtcGxhdGVcIjogPFBhcnNlcj57XG4gICAgLi4uaHRtbFBhcnNlcixcbiAgICBhc3RGb3JtYXQ6IFwiZ28tdGVtcGxhdGVcIixcbiAgICBwcmVwcm9jZXNzOiAodGV4dCkgPT4ge1xuICAgICAgLy9cbiAgICAgIGNvbnN0IHJlZ2V4cCA9IC8oPzp7ey4qP319KXwoPzo8c2NyaXB0KD86XFxufC4pKj8+KSgoPzpcXG58LikqPykoPzo8XFwvc2NyaXB0PikvZ207XG5cbiAgICAgIGxldCByZXBsYWNlZFRleHQgPSB0ZXh0LnRyaW0oKTtcbiAgICAgIGxldCBtYXRjaDogUmVnRXhwRXhlY0FycmF5IHwgbnVsbDtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tY29uZGl0aW9uYWwtYXNzaWdubWVudFxuICAgICAgd2hpbGUgKChtYXRjaCA9IHJlZ2V4cC5leGVjKHRleHQpKSAhPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG1hdGNoWzBdO1xuXG4gICAgICAgIGlmICghcmVzdWx0LmluY2x1ZGVzKFwie3tcIikpIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNsZWFuZWRSZXN1bHQgPSByZXN1bHRcbiAgICAgICAgICAvLyBjbGVhbiBleGNlcHQgZm9yIGh5cGhlbnMsIHNob3J0Y29kZXMsIGNvbW1lbnRzXG4gICAgICAgICAgLnJlcGxhY2UoL3t7KD8hWy08XXwoPzpcXC9cXCopKVsgXFx0XSovZywgXCJ7eyBcIilcbiAgICAgICAgICAucmVwbGFjZSgvWyBcXHRdKig/PCFbLT5dfCg/OlxcKlxcLykpfX0vZywgXCIgfX1cIilcblxuICAgICAgICAgIC8vIGNsZWFuIGh5cGhlbnNcbiAgICAgICAgICAucmVwbGFjZSgve3stWyBcXHRdKi9nLCBcInt7LSBcIilcbiAgICAgICAgICAucmVwbGFjZSgvWyBcXHRdKi19fS9nLCBcIiAtfX1cIilcblxuICAgICAgICAgIC8vIGNsZWFuIHNob3J0Y29kZXMsIGUuZy4gXCJ7ezwgICAgeWVhciAgICA+fX1cIiAtPiBcInt7PCB5ZWFyID59fVwiXG4gICAgICAgICAgLnJlcGxhY2UoL3t7PFsgXFx0XSovZywgXCJ7ezwgXCIpXG4gICAgICAgICAgLnJlcGxhY2UoL1sgXFx0XSo+fX0vZywgXCIgPn19XCIpXG5cbiAgICAgICAgICAucmVwbGFjZSgvICpcXG4vZywgXCJcXG5cIilcbiAgICAgICAgICAudHJpbSgpO1xuXG4gICAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gYnVpbGRSZXBsYWNlbWVudChjbGVhbmVkUmVzdWx0KTtcblxuICAgICAgICByZXBsYWNlZFRleHQgPSByZXBsYWNlZFRleHQucmVwbGFjZShyZXN1bHQsIHJlcGxhY2VtZW50KTtcblxuICAgICAgICBjb25zdCBmb3JjZUxpbmVicmVhayA9ICEhcmVwbGFjZWRUZXh0Lm1hdGNoKFxuICAgICAgICAgIG5ldyBSZWdFeHAoYF5bIFxcdF0qJHtyZXBsYWNlbWVudH1bIFxcdF0qJGAsIFwiZ21cIilcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoZm9yY2VMaW5lYnJlYWsgJiYgIXJlcGxhY2VtZW50LmluY2x1ZGVzKFwiPFwiKSkge1xuICAgICAgICAgIGNvbnN0IGxpbmVicmVha1JlcGxhY2VtZW50ID0gYDwhLS1CUEdUJHtyZXBsYWNlbWVudH1FUEdULS0+YDtcblxuICAgICAgICAgIHJlcGxhY2VkVGV4dCA9IHJlcGxhY2VkVGV4dC5yZXBsYWNlKFxuICAgICAgICAgICAgcmVwbGFjZW1lbnQsXG4gICAgICAgICAgICBsaW5lYnJlYWtSZXBsYWNlbWVudFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmVwbGFjZW1lbnRzLnNldChsaW5lYnJlYWtSZXBsYWNlbWVudCwgY2xlYW5lZFJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVwbGFjZW1lbnRzLnNldChyZXBsYWNlbWVudCwgY2xlYW5lZFJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGJsb2NrSGFzaGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXCJNaXNzaW5nIGVuZGluZyBibG9jay5cIik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXBsYWNlZFRleHQ7XG4gICAgfSxcbiAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBsYW5ndWFnZXM6IFN1cHBvcnRMYW5ndWFnZVtdID0gW1xuICB7XG4gICAgbmFtZTogXCJHb1RlbXBsYXRlXCIsXG4gICAgcGFyc2VyczogW1wiZ28tdGVtcGxhdGVcIl0sXG4gICAgZXh0ZW5zaW9uczogW1xuICAgICAgXCIuZ28uaHRtbFwiLFxuICAgICAgXCIuZ29odG1sXCIsXG4gICAgICBcIi5nb3RtcGxcIixcbiAgICAgIFwiLmdvLnRtcGxcIixcbiAgICAgIFwiLnRtcGxcIixcbiAgICAgIFwiLnRwbFwiLFxuICAgICAgXCIuaHRtbC50bXBsXCIsXG4gICAgICBcIi5odG1sLnRwbFwiLFxuICAgIF0sXG4gICAgdnNjb2RlTGFuZ3VhZ2VJZHM6IFtcImdvdGVtcGxhdGVcIiwgXCJnb2h0bWxcIiwgXCJHb1RlbXBsYXRlXCIsIFwiR29IVE1MXCJdLFxuICB9LFxuXTtcblxuZnVuY3Rpb24gcmVwbGFjZVNpbmdsZXMoaW5wdXQ6IHN0cmluZywgcmVwbGFjZWRIYXNoZXMgPSBuZXcgQXJyYXk8c3RyaW5nPigpKSB7XG4gIGNvbnN0IHJlZ2V4cCA9IC8oPzo8IS0tQlBHVCk/QlBHVC4qP0VQR1QoPzpFUEdULS0+KT8vZztcblxuICBsZXQgcmVzdWx0ID0gaW5wdXQ7XG4gIGxldCBtYXRjaDogUmVnRXhwRXhlY0FycmF5IHwgbnVsbDtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbmRpdGlvbmFsLWFzc2lnbm1lbnRcbiAgd2hpbGUgKChtYXRjaCA9IHJlZ2V4cC5leGVjKGlucHV0KSkgIT0gbnVsbCkge1xuICAgIGNvbnN0IGhhc2ggPSBtYXRjaFswXTtcblxuICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gcmVwbGFjZW1lbnRzLmdldChoYXNoKTtcblxuICAgIGlmIChyZXBsYWNlbWVudCkge1xuICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoaGFzaCwgcmVwbGFjZW1lbnQpO1xuICAgICAgcmVwbGFjZWRIYXNoZXMucHVzaChoYXNoKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5sZXQgbGFzdE1pc3NlZEJyYWNrZXQgPSBmYWxzZTtcblxuZnVuY3Rpb24gcmVwbGFjZUJsb2NrcyhpbnB1dDogc3RyaW5nLCByZXBsYWNlZEhhc2hlcyA9IG5ldyBBcnJheTxzdHJpbmc+KCkpIHtcbiAgbGV0IHJlc3VsdCA9IGlucHV0O1xuXG4gIGNvbnN0IGZ1bGxPcGVuaW5nVGFncyA9IGlucHV0Lm1hdGNoKC88QlBHVC4qP0VQR1Q+L2cpID8/IFtdO1xuICBjb25zdCBvcGVuT3BlbmluZ1RhZyA9IChpbnB1dC5tYXRjaCgvPEJQR1QuKj9FUEdUKD8hPikvZykgPz8gW10pWzBdO1xuICBjb25zdCBmdWxsQ2xvc2luZ1RhZ3MgPSBpbnB1dC5tYXRjaCgvPFxcL0JQR1QuKj9FUEdUPi9nKSA/PyBbXTtcbiAgY29uc3Qgb3BlbkNsb3NpbmdUYWcgPSAoaW5wdXQubWF0Y2goLzxcXC9CUEdULio/RVBHVCg/IT4pL2cpID8/IFtdKVswXTtcblxuICBpZiAobGFzdE1pc3NlZEJyYWNrZXQgJiYgaW5wdXQubWF0Y2goL1tcXHQgXSo+LykpIHtcbiAgICBsYXN0TWlzc2VkQnJhY2tldCA9IGZhbHNlO1xuICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKC9bXFx0IF0qPi8sIFwiXCIpO1xuICB9XG5cbiAgZnVsbE9wZW5pbmdUYWdzLmZvckVhY2goKG9wZW5pbmdUYWcpID0+IHtcbiAgICByZXBsYWNlZEhhc2hlcy5wdXNoKG9wZW5pbmdUYWcpO1xuICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKG9wZW5pbmdUYWcsIHJlcGxhY2VtZW50cy5nZXQob3BlbmluZ1RhZykhKTtcbiAgfSk7XG5cbiAgaWYgKG9wZW5PcGVuaW5nVGFnKSB7XG4gICAgY29uc3QgZml4ZWRPcGVuaW5nVGFnID0gb3Blbk9wZW5pbmdUYWcgKyBcIj5cIjtcbiAgICBsYXN0TWlzc2VkQnJhY2tldCA9IHRydWU7XG5cbiAgICByZXBsYWNlZEhhc2hlcy5wdXNoKGZpeGVkT3BlbmluZ1RhZyk7XG4gICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2Uob3Blbk9wZW5pbmdUYWcsIHJlcGxhY2VtZW50cy5nZXQoZml4ZWRPcGVuaW5nVGFnKSEpO1xuICB9XG5cbiAgZnVsbENsb3NpbmdUYWdzLmZvckVhY2goKGZ1bGxDbG9zaW5nVGFnKSA9PiB7XG4gICAgcmVwbGFjZWRIYXNoZXMucHVzaChmdWxsQ2xvc2luZ1RhZyk7XG4gICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoZnVsbENsb3NpbmdUYWcsIHJlcGxhY2VtZW50cy5nZXQoZnVsbENsb3NpbmdUYWcpISk7XG4gIH0pO1xuXG4gIGlmIChvcGVuQ2xvc2luZ1RhZykge1xuICAgIGNvbnN0IGZpeGVkQ2xvc2luZ1RhZyA9IG9wZW5DbG9zaW5nVGFnICsgXCI+XCI7XG4gICAgbGFzdE1pc3NlZEJyYWNrZXQgPSB0cnVlO1xuXG4gICAgcmVwbGFjZWRIYXNoZXMucHVzaChmaXhlZENsb3NpbmdUYWcpO1xuICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKG9wZW5DbG9zaW5nVGFnLCByZXBsYWNlbWVudHMuZ2V0KGZpeGVkQ2xvc2luZ1RhZykhKTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBjb25zdCBwcmludGVycyA9IHtcbiAgXCJnby10ZW1wbGF0ZVwiOiA8UHJpbnRlcj57XG4gICAgZW1iZWQ6IChfLCBfXywgdGV4dFRvRG9jLCBvcHRpb25zKSA9PiB7XG4gICAgICBjb25zdCBodG1sRG9jID0gdGV4dFRvRG9jKG9wdGlvbnMub3JpZ2luYWxUZXh0LCB7XG4gICAgICAgIHBhcnNlcjogXCJodG1sXCIsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVwbGFjZWRIYXNoZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgIGNvbnN0IG1hcHBlZERvYyA9IGRvYy51dGlscy5tYXBEb2MoaHRtbERvYywgKGRvY0xlYWYpID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBkb2NMZWFmICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgcmV0dXJuIGRvY0xlYWY7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVzdWx0ID0gZG9jTGVhZjtcblxuICAgICAgICByZXN1bHQgPSByZXBsYWNlU2luZ2xlcyhyZXN1bHQsIHJlcGxhY2VkSGFzaGVzKTtcblxuICAgICAgICByZXN1bHQgPSByZXBsYWNlQmxvY2tzKHJlc3VsdCwgcmVwbGFjZWRIYXNoZXMpO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KTtcblxuICAgICAgcmVwbGFjZWRIYXNoZXMuZm9yRWFjaCgoaGFzaCkgPT4gcmVwbGFjZW1lbnRzLmRlbGV0ZShoYXNoKSk7XG5cbiAgICAgIHJldHVybiBtYXBwZWREb2M7XG4gICAgfSxcbiAgfSxcbn07XG4iXX0=